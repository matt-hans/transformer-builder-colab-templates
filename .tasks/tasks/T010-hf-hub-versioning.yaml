---
id: T010
title: "HF Hub Versioning - Tag Models with Training Metadata"
status: pending
priority: P2
dependencies: [T008]
tags: [mlops, model-registry, huggingface, versioning, phase-1]
estimated_tokens: 8000
actual_tokens: 0
created_at: "2025-01-15"
updated_at: "2025-01-15"
---

## Description

Implement semantic versioning for models uploaded to HF Hub. Tag models with training metadata (dataset, metrics, git commit) for reproducibility and lineage tracking.

## Business Context

**Problem**: Users upload multiple model versions but can't track which version corresponds to which experiment or training run.

**Value**: Clear version history. Users can identify exact model version for any result, rollback to previous versions, and understand model evolution over time.

**User Story**: As an ML practitioner, I want models tagged with versions and metadata so that I can track model improvements, rollback to stable versions, and reproduce any published result.

## Acceptance Criteria

1. [ ] Implement semantic versioning (v1.0.0, v1.1.0, v2.0.0)
2. [ ] Tag models with training metadata (dataset, final_metrics, git_commit)
3. [ ] Create version comparison utility
4. [ ] Add model changelog generation
5. [ ] Enable loading specific model versions by tag
6. [ ] Auto-increment version on upload
7. [ ] Document versioning scheme in notebook
8. [ ] Test upload of 3+ versions
9. [ ] Add version info to model card
10. [ ] Create version history visualization

## Technical Implementation

```python
# Version Management

import re
from packaging import version as pkg_version

def get_latest_model_version(repo_id):
    """Get latest semantic version from HF Hub repo."""
    from huggingface_hub import HfApi
    api = HfApi()

    # Get all tags/commits
    try:
        refs = api.list_repo_refs(repo_id)
        versions = []

        # Extract semantic versions from tags
        for tag in refs.tags:
            match = re.match(r'v?(\d+\.\d+\.\d+)', tag.name)
            if match:
                versions.append(pkg_version.parse(match.group(1)))

        if versions:
            latest = max(versions)
            return str(latest)
        else:
            return "0.0.0"  # No versions yet

    except Exception as e:
        print(f"‚ö†Ô∏è Could not fetch versions: {e}")
        return "0.0.0"


def increment_version(current_version, bump_type="patch"):
    """
    Increment semantic version.

    Args:
        current_version: str, e.g., "1.2.3"
        bump_type: "major" | "minor" | "patch"

    Returns:
        new_version: str, e.g., "1.2.4"
    """
    v = pkg_version.parse(current_version)
    major, minor, patch = v.major, v.minor, v.micro

    if bump_type == "major":
        return f"{major + 1}.0.0"
    elif bump_type == "minor":
        return f"{major}.{minor + 1}.0"
    elif bump_type == "patch":
        return f"{major}.{minor}.{patch + 1}"
    else:
        raise ValueError(f"Invalid bump_type: {bump_type}")


def upload_versioned_model(
    model,
    repo_id,
    metrics,
    dataset_name,
    bump_type="patch",
    git_commit=None,
    changelog_entry=None,
):
    """
    Upload model to HF Hub with semantic versioning and metadata.

    Args:
        model: PyTorch model
        repo_id: HuggingFace repo ID
        metrics: dict of final metrics
        dataset_name: Training dataset name
        bump_type: "major" | "minor" | "patch"
        git_commit: Optional git commit hash
        changelog_entry: Optional changelog description

    Returns:
        version_tag: str, version tag created
    """
    from huggingface_hub import HfApi
    api = HfApi()

    # Get latest version and increment
    current_version = get_latest_model_version(repo_id)
    new_version = increment_version(current_version, bump_type)
    version_tag = f"v{new_version}"

    print(f"üì¶ Uploading model version: {version_tag}")
    print(f"   Previous version: v{current_version}")

    # Save model locally
    save_dir = f"./model_{version_tag}"
    os.makedirs(save_dir, exist_ok=True)

    torch.save(model.state_dict(), f"{save_dir}/pytorch_model.bin")

    # Save version metadata
    version_metadata = {
        "version": new_version,
        "created_at": datetime.now().isoformat(),
        "dataset": dataset_name,
        "metrics": metrics,
        "git_commit": git_commit,
        "changelog": changelog_entry,
    }

    with open(f"{save_dir}/version_info.json", "w") as f:
        json.dump(version_metadata, f, indent=2)

    # Upload to HF Hub
    api.upload_folder(
        folder_path=save_dir,
        repo_id=repo_id,
        commit_message=f"Release {version_tag}: {changelog_entry or 'Model update'}",
    )

    # Create git tag
    api.create_tag(
        repo_id=repo_id,
        tag=version_tag,
        tag_message=f"Release {version_tag}\n\n{changelog_entry or ''}",
    )

    print(f"‚úÖ Model uploaded with version {version_tag}")
    print(f"   Dataset: {dataset_name}")
    print(f"   Metrics: {metrics}")
    print(f"   View at: https://huggingface.co/{repo_id}/tree/{version_tag}")

    # Update changelog
    update_changelog(repo_id, version_tag, metrics, changelog_entry)

    return version_tag


def update_changelog(repo_id, version_tag, metrics, changelog_entry):
    """Update CHANGELOG.md in model repo."""

    changelog_path = "CHANGELOG.md"

    # Download existing changelog or create new
    try:
        from huggingface_hub import hf_hub_download
        hf_hub_download(repo_id=repo_id, filename=changelog_path, local_dir=".")
        with open(changelog_path, "r") as f:
            existing_changelog = f.read()
    except:
        existing_changelog = "# Changelog\n\nAll notable changes to this model will be documented in this file.\n\n"

    # Add new entry
    new_entry = f"""
## [{version_tag}] - {datetime.now().strftime('%Y-%m-%d')}

### Changes
{changelog_entry or "Model update"}

### Metrics
- Validation Loss: {metrics.get('val_loss', 'N/A')}
- Validation Perplexity: {metrics.get('val_perplexity', 'N/A')}
- Validation Accuracy: {metrics.get('val_accuracy', 'N/A')}

"""

    updated_changelog = existing_changelog.replace(
        "# Changelog\n\nAll notable changes to this model will be documented in this file.\n\n",
        f"# Changelog\n\nAll notable changes to this model will be documented in this file.\n\n{new_entry}"
    )

    # Save and upload
    with open(changelog_path, "w") as f:
        f.write(updated_changelog)

    from huggingface_hub import HfApi
    api = HfApi()
    api.upload_file(
        path_or_fileobj=changelog_path,
        path_in_repo=changelog_path,
        repo_id=repo_id,
        commit_message=f"Update changelog for {version_tag}",
    )

    print(f"‚úÖ Changelog updated")


# Load Specific Version

def load_model_version(repo_id, version_tag="latest"):
    """
    Load specific model version from HF Hub.

    Args:
        repo_id: HuggingFace repo ID
        version_tag: "latest" or "v1.2.3"

    Returns:
        model_state_dict, version_metadata
    """
    from huggingface_hub import hf_hub_download

    if version_tag == "latest":
        version_tag = f"v{get_latest_model_version(repo_id)}"

    print(f"üì• Loading model version: {version_tag}")

    # Download model files
    model_path = hf_hub_download(
        repo_id=repo_id,
        filename="pytorch_model.bin",
        revision=version_tag,
    )

    metadata_path = hf_hub_download(
        repo_id=repo_id,
        filename="version_info.json",
        revision=version_tag,
    )

    # Load
    state_dict = torch.load(model_path, map_location='cpu')

    with open(metadata_path, 'r') as f:
        metadata = json.load(f)

    print(f"‚úÖ Loaded {version_tag}")
    print(f"   Dataset: {metadata['dataset']}")
    print(f"   Metrics: {metadata['metrics']}")

    return state_dict, metadata
```

## Design Decisions

**Decision 1**: Use semantic versioning (major.minor.patch)
- **Rationale**: Industry standard, conveys breaking changes vs improvements
- **Alternative considered**: Date-based versioning (harder to understand impact)
- **Trade-off**: Requires manual bump_type specification, but clearer meaning

**Decision 2**: Auto-generate CHANGELOG.md
- **Rationale**: Track model evolution, required for reproducibility
- **Alternative considered**: Manual changelog (often forgotten)
- **Trade-off**: Automated entries may be generic, but better than nothing

## Progress Log

- [ ] Created task specification
- [ ] Implemented versioning functions
- [ ] Added changelog generation
- [ ] Tested multi-version upload
- [ ] Committed with message: "feat(mlops): add semantic versioning for HF Hub models"

## Completion Checklist

- [ ] All acceptance criteria met
- [ ] All test scenarios pass
- [ ] Code follows style guide
- [ ] Documentation complete
- [ ] Tested in Colab
- [ ] Git committed
