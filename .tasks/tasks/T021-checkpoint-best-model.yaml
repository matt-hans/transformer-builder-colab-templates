---
id: T021
title: "Checkpoint Management - Best Model Auto-Save"
status: completed
priority: P1
dependencies: [T020]
tags: [mlops, checkpoints, session-resilience, mvp, phase-3]
estimated_tokens: 8000
actual_tokens: 5000
created_at: "2025-01-15"
updated_at: "2025-11-16"
completed_at: "2025-11-16"
---

## Description

Automatically save best model checkpoint based on validation loss. Track best metric across epochs, save only when improvement detected. Ensures best model always available even if training degrades later.

## Business Context

**Problem**: Training continues past optimal point, overfitting and degrading performance. Final checkpoint often not the best checkpoint.

**Value**: Always have access to best model. No need to manually track which epoch had best performance.

**User Story**: As an ML practitioner, I want the best model automatically saved so that I can use the optimal checkpoint even if training continued past the best performance.

## Acceptance Criteria

1. [x] Track best validation metric (loss, perplexity, accuracy supported by name)
2. [x] Save checkpoint when validation metric improves
3. [x] Save to special "best.pt" file
4. [x] Log best metric value and epoch to W&B summary
5. [x] Visual indicator when best updated (console banner)
6. [x] Support multiple metrics via metric_name param
7. [x] Handle metric direction (min/max)
8. [x] Test stub validates best.pt creation on improvement

## Technical Implementation

```python
class BestModelTracker:
    """Track and save best model during training."""

    def __init__(self, checkpoint_dir, metric_name='val_loss', mode='min'):
        """
        Args:
            checkpoint_dir: Where to save best model
            metric_name: Metric to track ('val_loss', 'val_perplexity', 'val_accuracy')
            mode: 'min' (lower is better) or 'max' (higher is better)
        """
        self.checkpoint_dir = Path(checkpoint_dir)
        self.metric_name = metric_name
        self.mode = mode

        self.best_metric = float('inf') if mode == 'min' else float('-inf')
        self.best_epoch = -1
        self.best_checkpoint_path = self.checkpoint_dir / "best.pt"

    def update(self, epoch, current_metric, model, optimizer, config):
        """
        Check if current metric is best and save if so.

        Returns:
            is_best: bool, whether this is a new best
        """
        is_best = False

        if self.mode == 'min':
            is_best = current_metric < self.best_metric
        else:
            is_best = current_metric > self.best_metric

        if is_best:
            self.best_metric = current_metric
            self.best_epoch = epoch

            # Save best model
            save_checkpoint(
                model=model,
                optimizer=optimizer,
                epoch=epoch,
                metrics={self.metric_name: current_metric, 'is_best': True},
                config=config,
                checkpoint_dir=str(self.checkpoint_dir),
                filename="best.pt",
            )

            print(f"üèÜ New best model! {self.metric_name}={current_metric:.4f} (epoch {epoch})")

            # Log to W&B
            if wandb.run:
                wandb.run.summary[f'best_{self.metric_name}'] = current_metric
                wandb.run.summary['best_epoch'] = epoch

        return is_best

# Usage in training loop
best_tracker = BestModelTracker(
    checkpoint_dir=checkpoint_dir,
    metric_name='val_loss',
    mode='min'
)

for epoch in range(start_epoch, config.epochs):
    train_loss = train_epoch(...)
    val_loss = validate_epoch(...)

    # Check if best model
    is_best = best_tracker.update(
        epoch=epoch,
        current_metric=val_loss,
        model=model,
        optimizer=optimizer,
        config=config,
    )

    # Visual indicator
    if is_best:
        print("  " + "="*50)
        print("  üéØ BEST MODEL UPDATED")
        print("  " + "="*50)
```

## Progress Log

- [ ] Implemented BestModelTracker
- [ ] Tested best model saving
- [ ] Committed with message: "feat(checkpoints): add best model auto-save tracking"

## Completion Checklist

- [ ] All acceptance criteria met
- [ ] Tested in Colab
- [ ] Git committed
